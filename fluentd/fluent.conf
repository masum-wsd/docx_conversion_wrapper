# fluent.conf
# This Fluentd configuration file is optimized for use with Elasticsearch, focusing on Spring Boot logging.

# Input Source - Forward logs from applications
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Buffer Settings to manage log burst and persistence
<buffer>
  # Specify where to store buffer data, essential for preventing data loss
  path /fluentd/buffer/elasticsearch
  # Limit buffer size to prevent disk space overuse
  total_limit_size 1GB
  # Set chunk limit size and time for periodic flushing
  chunk_limit_size 8MB
  flush_interval 5s
  retry_limit 10
  retry_wait 1s
  retry_max_interval 30s
  overflow_action block
</buffer>

# Match All Logs and Send to Elasticsearch
<match **>
  @type elasticsearch
  @id es_output
  host localhost
  port 9200
  scheme http  # Change to https if you are using secure Elasticsearch
  logstash_format true
  logstash_prefix spring-boot-logs
  include_tag_key true
  tag_key @log_name


  # Set up authentication if required
  # user ${ELASTICSEARCH_USER}
  # password ${ELASTICSEARCH_PASSWORD}

  # Retry and Timeout Configuration
  write_operation create
  reload_connections true
  reconnect_on_error true
  request_timeout 30s
  buffer_path /fluentd/buffer/elasticsearch
</match>

# Filtering - Modify logs before sending to Elasticsearch
<filter **>
  @type record_transformer
  enable_ruby
  <record>
    hostname "#{Socket.gethostname}"
    app_name "spring-boot-app"
    env "#{ENV['FLUENT_ENV'] || 'development'}"
  </record>
</filter>

# Handling Errors - Send errors to an alternate log file for troubleshooting
<label @ERROR>
  <match **>
    @type file
    path /fluentd/error_logs/failed.log
  </match>
</label>

